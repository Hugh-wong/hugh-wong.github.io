<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>呛呛呛</title>
    <link rel="stylesheet" type="text/css" href="/theme/css/screen.min.css">
    <link rel="stylesheet" type="text/css" href="/theme/css/highlight.min.css">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="publisher" href="">
    <link rel="apple-touch-startup-image" href="/theme/images/logo.png">
    <link type="text/plain" rel="socialmedia" href="/socialmedia.txt">
    <link rel="dns-prefetch" href=""/>
    <!--<link rel="dns-prefetch" href="//www.gstatic.com"/>
    <link rel="dns-prefetch" href="//fonts.gstatic.com"/>
    <link rel="dns-prefetch" href="//fonts.googleapis.com"/>
    <link rel="dns-prefetch" href="//accounts.google.com"/>
    <link rel="dns-prefetch" href="//ssl.google-analytics.com"/>
    <link rel="dns-prefetch" href="//www.google-analytics.com"/>
    <link rel="dns-prefetch" href="//googleads.g.doubleclick.net"/>
    <link rel="dns-prefetch" href="//pagead2.googlesyndication.com"/>
    <link rel="dns-prefetch" href="//twemoji.maxcdn.com"/>-->
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="application-name" content="呛呛呛"/>
    <meta name="msapplication-starturl" content="http:"/>
    <meta name="msapplication-tooltip" content=""/>
    <meta name="msapplication-window" content="width=1024;height=768"/>
    <meta name="msapplication-task" content="name=呛呛呛;action-uri=http:;icon-uri=/theme/images/favicon.ico"/>
    <meta name="msapplication-TileImage" content="/theme/images/favicon_120.png"/>
    <meta name="msapplication-TileColor" content="#1F1F21"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="imagetoolbar" content="no">
    <meta http-equiv="pragma" content="cache">
    <meta http-equiv="cache-control" content="cache">
    <meta http-equiv="vary" content="content-language">
    <meta http-equiv="Cache-control" content="max-age=2592000, public">
    <meta http-equiv="content-style-type" content="text/css">
    <meta name="application-name" content="呛呛呛">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="google-site-verification" content="">
    <meta name="alexaVerifyID" content=""/>
    <meta name="wot-verification" content=""/>
    <meta name="msvalidate.01" content="" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="medium" content="mult">
    <meta name="adblock" content="disable">
    <meta name="rating" content="General">
    <meta name="resource-type" content="document">
    <meta name="revisit-after" content="1 days">
    <meta name="revisit" content="1">
    <meta name="robots" content="index,follow">
    <meta name="no-email-collection" content="http://www.unspam.com/noemailcollection/">
    <link rel="apple-touch-icon" sizes="114x114" href="/theme/images/favicon_114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/theme/images/favicon_120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/theme/images/favicon_76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/theme/images/favicon_72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/theme/images/favicon_60.png">
    <link rel="apple-touch-icon" sizes="57x57" href="/theme/images/favicon_57.png">
    <link rel="icon" type="image/png" href="/theme/images/favicon_96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/theme/images/favicon_32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/theme/images/favicon_16.png" sizes="16x16">
    <link rel="shortcut icon" href="/theme/images/favicon.ico">
    <script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', '', 'auto');ga('send', 'pageview');var _qevents = _qevents || [];</script>
    <!--<script src="//twemoji.maxcdn.com/twemoji.min.js"></script>-->
</head>
<body class="home-template nav-closed" itemscope itemtype="http://schema.org/WebPage">
<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-ML9KT2"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-ML9KT2');</script>
<!-- End Google Tag Manager -->
    <meta itemprop="name" content="呛呛呛">
    <meta itemprop="url" content="">
    <meta itemprop="headline" content="呛呛呛 || ">
    <meta itemprop="description about" content="">
    <meta itemprop="keywords" content="gnu, linux, software libre, código abierto, tecnología">
    <meta itemprop="primaryImageOfPage" content="/theme/images/logo.png">
    <meta itemprop="inLanguage" content="es">
<nav class="nav">
    <h3 class="nav-title">菜单</h3>
    <a href="#" class="nav-close">
        <span class="hidden">隐藏</span>
    </a>
    <ul role="menubar">
        <li class="nav-current" role="presentation"><a  href="/index.html" title="呛呛呛 | Index" itemprop="name" itemprop="significantLink">首页</a></li>
        <li class="nav-current" role="presentation"><a  href="/pages/guan-yu-ben-zhan.html" title="呛呛呛 |关于本站" itemprop="name" itemprop="significantLink">关于本站</a></li>
        <li class="nav-current" role="presentation"><a  href="/archives.html" title="呛呛呛 | Archives" itemprop="name" itemprop="significantLink">全部文章</a></li>
        <li class="nav-current" role="presentation"><a  href="/category/du-shu-bi-ji.html" title="呛呛呛 | Categoryies" itemprop="name" itemprop="significantLink">读书笔记</a></li>
        <li class="nav-current" role="presentation"><a  href="/category/ge-ren-xin-de.html" title="呛呛呛 | Categoryies" itemprop="name" itemprop="significantLink">个人心得</a></li>
        <li class="nav-current" role="presentation"><a  href="/category/ji-zhu-yan-jiu-node.html" title="呛呛呛 | Categoryies" itemprop="name" itemprop="significantLink">技术研究[node]</a></li>
        <li class="nav-current" role="presentation"><a  href="/category/ji-zhu-yan-jiu-python.html" title="呛呛呛 | Categoryies" itemprop="name" itemprop="significantLink">技术研究[python]</a></li>
    </ul>
</nav>
<span class="nav-cover"></span>    <div class="site-wrapper">
         <!--<header class="main-header post-head" style="background-image: url(/theme/images/bear.jpg)" itemscope itemtype="http://schema.org/WPHeader">-->
         <header class="main-header post-head" style="background-image: url(/theme/images/background.jpg)"> 
            <nav class="main-nav overlay clearfix">
                <a class="menu-button" href="#">
                    <span class="burger">&#9776;</span>
                    <span class="word">菜单</span>
                </a>
            </nav>
            <!-- <div class="vertical">
                <div class="main-header-content inner">
                    <h1 class="page-title" itemprop="headline">呛呛呛</h1>
                    <h2 class="page-description" itemprop="description"></h2>
                </div>
            </div> -->
 <!--            <a class="scroll-down icon-arrow-left blink_me" href="#content" data-offset="-45">
                <span class="hidden">Scroll Down</span>
            </a> -->
        </header>
<main id="content" class="content" role="main">
    <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting" itemprop="blogPost">
        <header class="post-header">
            <h1 class="post-title" itemprop="headline">说说序列化那些事</h1>
            <section class="post-meta">
                <!-- <span class="entry-author" itemscope="" itemtype="http://schema.org/Person" itemprop="author">
                    <span itemprop="name">齐德隆冬</span></span> -->
                <time itemprop="datePublished" datetime="2017YYY-00M-%DD">Friday, June 09, 2017</time>
            </section>
        </header>
        <section class="post-content" style="margin-top:20px;">
            <h3>什么是序列化？</h3>
<p>狭义上的序列化，是指将对象数据转换为可以存储或传输的形式的过程，这里引用维基的定义。</p>
<blockquote>
<p>In computer science, in the context of data storage, serialization is the process of translating data structures or object state into a format that can be stored (for example, in a file or memory buffer) or transmitted (for example, across a network connection link) and reconstructed later (possibly in a different computer environment).</p>
</blockquote>
<p>我这里要讲的，却是不只是关于数据的转换，而是指在典型的web应用中，数据从发送请求，到后端解析，再入库，最后返回的整个过程。</p>
<p>这里以具体的一个论坛为例：</p>
<p>一个典型的论坛应用，可能有threads帖子这个模型。
比如新建一个帖子时，前端会向后端发送一个请求,略过http协议的定义与处理，这里假定后端已经可以拿到数据，是这样的：<code>{'title': '测试标题', 'content': '这是内容'}</code>。</p>
<p>后端如何处理这些数据，通常来讲，会根据不同的技术栈，有不同的实现：比如django的表单(form)的实例化对象，比如<code>drf(django rest framework)</code>的serializer对象取。</p>
<p>取完了数据，通常还需要对数据进行校验，比如title不能超过20个汉字。校验过了没有问题，就可以入库了。
入库完成后，还需要给前端的请求返回数据，以便于前端渲染数据。比如通常这里会带这些信息：<code>{'id': 1, 'title': '测试标题', 'content': '', 'create_time': '2017-06-09 11:00:01', 'owner_id': 1}</code>。</p>
<p>到此为止，一整个流程算是完毕了，我们来梳理一下，这个流程应该是这样的：</p>
<p><code>网络请求(request)--&gt;解析(parse)--&gt;校验与转换(validate and format)--&gt;入库/出库(storage)--&gt;序列化(serialize)--&gt;响应(response)</code></p>
<p>这篇文章要讲的内容，是抛开了除<code>网络请求</code>、<code>解析</code>、<code>响应</code>这三个过程，重点在于中间部分的<code>校验与转换--&gt;入库/出库--&gt;序列化</code>过程。</p>
<h3>校验与转换</h3>
<p>如以下是一个创建用户的请求后端处理伪代码：</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">validate_email</span><span class="p">(</span><span class="n">email_str</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">email_str</span> <span class="ow">and</span> <span class="s">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">email_str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">email</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> 

    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> 
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">])</span>
    <span class="c"># doing something to create</span>
</pre></div>


<p>可以看到，这里有三个不同的<code>字段(field)</code>需要处理。
每个field的校验与格式转换都是相互独立的，如果校验失败，则应该抛出异常，返回给前端。
针对不同的请求，来写不同的校验规则，好处是灵活性高，坏处就是代码不优雅，重复性高。
这样的类似的代码会出现很多次，还需要手动捕获异常。</p>
<p>如何将这段逻辑写的更优雅？</p>
<p>在这个基础上，弄一个简单的字段似乎就能解决问题：</p>
<div class="highlight"><pre><span class="n">cfg_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="s">&#39;email&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">validate_email</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>像这样，配一个简单的映射：</p>
<ul>
<li>name，需要转换成username，类型是str，不需要校验</li>
<li>id，类型是int，不需要校验</li>
<li>email，类型是str，需要校验是否包含有@与.</li>
</ul>
<p>这样可以把需要处理的地方，都通过读取这个配置来完成数据的转换与格式化。以下是通用的逻辑处理伪代码：</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">cfg_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">temp_v</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">temp_v</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">temp_v</span><span class="p">)</span> <span class="c"># 类型转换</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">temp_v</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span><span class="n">temp_v</span><span class="p">)</span> <span class="c"># 如需要校验则校验</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span>

    <span class="nb">locals</span><span class="p">()[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">tempv</span>
</pre></div>


<p>这样虽然能够解决大部分问题了，但是还是有一些问题没有解决的。</p>
<blockquote>
<p>字典的重复定义</p>
</blockquote>
<p>比如用户的创建的字典，就是上面的字典里再增加一个键值对，来处理password。</p>
<blockquote>
<p>对于请求只带有部分字段的处理</p>
</blockquote>
<p>比如用户的修改资料，可以修改邮箱，昵称，但是提交过来的可能只有昵称字段。</p>
<blockquote>
<p>批量校验</p>
</blockquote>
<p>比如需要批量创建用户。</p>
<blockquote>
<p>对象校验</p>
</blockquote>
<p>比如商品有两个价格，一个是优惠价格，一个是标价，这里优惠价格应该低于标价。</p>
<p>当然呢，我认为，好的解决方案不一定要解决所有的问题，只要足够简单和灵活，能够解决大部分的问题就行。</p>
<h4>有哪些现成的解决方案？</h4>
<p>github上有不少的开源组件，有的只做了校验，有的包括上面的基本流程。由于本文立意是为了讲清楚整个过程，因此不在这里一一展开了，只讲以下三个。</p>
<ol>
<li>django的form</li>
<li>drf的serializer</li>
<li>marshmallow</li>
</ol>
<p>除此之外，还有一些像google的protobuf，apache的thrift协议，这种数据结构的协议，更多侧重于数据的校验与转换，对于数据的中间流动并没有直接或者间接参与。</p>
<h5>django的表单(form)组件</h5>
<p>由于django的MTV架构，后端与前端相对有较强的耦合，form甚至可以在后端配置前端的显示样式。
但是除开这个，表单的使用还是很方便的，特别是模型表单(modelform)，能够直接关联到模型(model)，使用model的定义来作转换与校验。
并且也提供了很好的扩展方法。</p>
<p>关键是与orm的结合非常好，数据经过校验就可以直接入库了。对于传统的表单提交，这个组件确实非常方便无痛。
但是由于前后端分离(如移动app)的开发模式流行，这种传统交互的方式使用的越来越少了。</p>
<h5>drf的serializer</h5>
<p>drf是基于django用于专门开发restful风格的api的一套组件。其中就包括了serializer组件。</p>
<p>serializer负责的东西还是挺多的，像<code>校验与转换</code>不在话下，对于<code>入库/出库</code>的操作，也可以直接使用django的orm(object relation mapping)，但是它还负责响应的数据的序列化，即上面过程中提到的<code>序列化</code>的过程。</p>
<p>serializer也可以直接关联到对应的模型，跟上面的模型表单(modelform)类似。</p>
<p>并且对于批量的转换和局部的校验，也是很方便的。基本上能够满足上面所有需求了。</p>
<p>这么说起来，似乎话题到这里就可以完结了？</p>
<p>当然不，本文想探讨的是整个流程中遇到的各种问题和解决方案，这里drf确实能够满足大部分需求，但是，仍然会有一部分需求待提出和解决。</p>
<p>比如，如果不是使用django呢？如果django结合mongodb呢(mongodb尚没有django的官方orm支持)。</p>
<h5>marshmallow</h5>
<p><a href="https://github.com/marshmallow-code/marshmallow">查看链接</a></p>
<p>这个组件我没有实际使用，但是听到了好几次。</p>
<p>它脱离了orm的模型定义，自己弄了一个<code>模式(schema)</code>。模式的实例也能够校验与序列化对象/数据。</p>
<h3>入库/出库(storage)</h3>
<p>入库与出库，简单来讲，确实好像就是读写数据库，但是实际上还包括一个模式的定义。</p>
<p>一般来讲，一个orm应该包括好的模式的定义与设计，也包括database的管理（包括索引创建、表创建删除等）。</p>
<h5>为什么要有ORM呢？</h5>
<p>orm并非是凭空出来的，在没有orm的年代，一般会怎么操作呢？</p>
<ol>
<li>建立连接</li>
<li>编写sql</li>
<li>取出数据</li>
<li>数据转换</li>
</ol>
<p>这样每个操作，都要直接建立连接，并且要拼装sql，最后再转换。</p>
<p>这种写法当然也没有太大的问题，足够灵活，但是有大量重复的代码。</p>
<p>基于DRY原则，这里自然是想减少这部分代码的重复，orm的功能也就呼之欲出了。</p>
<p>以django的orm为例，简单讲一下它的基本功能：</p>
<ol>
<li>将定义好的模型映射到数据库</li>
<li>数据库连接管理</li>
<li>数据库操作解析映射(DML)</li>
<li>数据库管理(DDL)</li>
<li>数据的转换</li>
</ol>
<p>这里主要讲1，3，5。</p>
<p>定义好的模型映射到数据库，即通过类的定义，转换成ddl，比如</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">username</span><span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s">&quot;username&quot;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</pre></div>


<p>按这样定义，会被转换成对应的建表语句<code>create table user ...</code>。</p>
<p>然后对于sql的操作，也直接由对象的操作完成，如<code>User.objects.create(username="abc")</code>会被转换成<code>insert into table user(username) values('abc')</code>。</p>
<p>再就是对于数据的转换，比如要取出数据<code>User.objects.filter(username="abc")</code>，返回的可不是冷冰冰的<code>[(1, 'abc')]</code>，而是经由它转换成了一个User实例，它的id为1，username为abc。</p>
<h5>but how？</h5>
<p>ORM是如何做到这一点的呢？</p>
<p>这里有一个概念，叫做『模板编程』，即用户的模型，跟用户组的模型，对于数据库的操作，其实是一样的，所不同的，就是在于各自的模型定义，表名称上。</p>
<p>在python里，有一个概念，叫做metaclass，即元类，直观理解的话，就是生成类的类。</p>
<p>关于它的使用实践，可以参考我的<a href="/shi-xian-pythonzhong-de-mei-ju-lei-xing-pythonde-metaclassying-yong-ju-li.html">另一篇文章</a>。</p>
<p>通常来讲，它有两个概念<code>模型(Model)</code>与<code>字段(Field)</code>。</p>
<p>模型下面会定义许多的字段，不同的字段会映射不同的类型，并且一般会带有校验方法链。以下一段伪代码。</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Field</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validators</span> <span class="o">=</span> <span class="n">validators</span>

<span class="k">class</span> <span class="nc">IntField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">StrField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">IntField</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;user_id&quot;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">StrField</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
</pre></div>


<p>像这样，可以在Model里弄很多通用的方案，比如建数据库连接，操作映射，取到数据后映射等。</p>
<h4>有哪些orm呢？</h4>
<ol>
<li>django orm</li>
<li>sqlalchemy</li>
<li>mongoengine</li>
</ol>
<p>其中django的orm与sqlalchemy类似，均是给关系型数据库使用的，其中sqlalchemy可以结合其它的框架使用，如webpy, flask。
mongoengine可以结合mongodb与django使用。</p>
<h3>序列化</h3>
<p>序列化，似乎没有那么值得说的了，直接json dumps一下不就好了么？</p>
<p>理论上是这样的，但是……</p>
<p>与<code>校验与转换</code>一样，会需要字段的映射，会需要字段的转换，比如价格在数据库中存储时，是以分的形式保存的，前端显示需要转换成为￥168.00 元这样的显示。
还有的是数据库中的状态码显示，比如用户的性别，可能是以int的形式存储的，在页面上显示的时候，要转换成男/女或者male/female这样的显示。</p>
<p>还有就是，不同的请求，返回的数据字段也有不同，比如一般创建数据，比如帖子，可能会返回全部的字段，但是创建用户的时候，密码这个字段不能返回吧。</p>
<p>说到这里，应该也有人想到，跟上面的<code>校验与转换</code>一样，弄一个modelserializer，映射哪些字段，并且定义不同字段的转换方法。</p>
<h4>有哪些库支持？</h4>
<ol>
<li>drf serializer</li>
<li>marshmallow</li>
</ol>
<h4>drf serializer</h4>
<p>serializer其实本身包括valiate与serialize的功能的，并且做了强耦合，当然它可以定义字段的<code>read_only</code>或者<code>write_only</code>，在创建或者返回的时候字段不同。</p>
<h4>marshmallow</h4>
<p>marshmallow由于没有model的概念，它只有schema的概念，即可以定义不同的schema，来做序列化和反序列化。</p>
<p>但是也会有面临相同的困扰，即用户创建和用户修改时，两个schema非常类似，但也必须定义两份。</p>
<p>上面这两种，其实都是<code>校验与转换</code>与<code>序列化</code>强耦合的，相对来说，不够灵活，并且可能会带来一定的<code>序列化</code>的性能消耗。</p>
<h3>小结？</h3>
<p>在实践过程中，笔者尝试过django, drf的这一套体系，确实开发起来非常爽：</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;用于创建用户&quot;&quot;&quot;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">write_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">is_active</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="s">&#39;password&#39;</span><span class="p">,</span> <span class="s">&#39;email&#39;</span><span class="p">,</span> <span class="s">&#39;phone&#39;</span><span class="p">,</span> <span class="s">&#39;is_active&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">UserViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;用户的操作：列表、详情、修改、删除、创建&quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
</pre></div>


<p>像这样定义的，就能够处理好列表、详情、修改、删除、创建这五个功能了。</p>
<p>这样的功能足够满足大部分需求了，但是仍然有一些复杂的需求，这里列举一下：</p>
<blockquote>
<p>嵌套的结构处理</p>
</blockquote>
<p>数据不是一层不变的平铺数据，很有可能是有嵌套的数据，需要校验的逻辑能够递归校验。</p>
<blockquote>
<p>校验的一种特殊操作</p>
</blockquote>
<p>创建的时候，根据参数的不同，会有不同的额外参数，这里类似于有几个固定的子类，然后子类有不同字段属性。</p>
<p>上面的机制不能很好的处理，当时选择的是手动处理的这些数据，最后再手动处理的。</p>
<blockquote>
<p>返回数据的关联处理</p>
</blockquote>
<p>这一点，比如虽然创建了用户，但是希望返回的时候，带上用户所属的组。</p>
<p>除此之外，笔者遇到的一个更大的问题，就是：在django的体系里，这一套用起来很爽，可是一旦切换到其它不同的组件后，就没法移植了。
比如使用flask时，django与drf的这一套均无法使用了，但是业务中还是需要这些东西的。
也有例如使用mongodb时，原来的orm这一套可能不能使用了，不好与原来的<code>序列化结合</code>。</p>
<h3>真·小结</h3>
<p>似乎在这里，应该造一个轮子了，将<code>校验与转换</code>与<code>序列化</code>这两个从功能上分开，毕竟需要校验的数据，与需要返回的数据并不完全相同。</p>
<p>而且面对不同的数据库/存储，也有不同的orm实现，<code>模式</code>应该是能够适配不同的orm的，即适配器模式，根据不同的orm，适配不同的模式出来。</p>
<p>不过，这个坑，也不知道哪一天会填……</p>
            <!-- <br/>
<nav class="pagination" role="navigation">
    <ul>
    </ul>
</nav>            <br/>-->
            </section>
<!--         <footer class="post-footer">
        </footer>-->
        </article>
</main>
        <footer class="site-footer clearfix" role="contentinfo" itemscope itemtype="http://schema.org/WPFooter">
            <section class="copyright">
                <a itemprop="url" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" class="tooltip" data-tooltip="CC BY-NC-SA" target="_blank">
                CC Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
            </section>
            <section class="poweredby">Proudly published with <a href="https://getpelican.org">Pelican</a></section>
        </footer>
    </div>
    <script type="text/javascript" src="/theme/js/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="/theme/js/jquery.fitvids.min.js"></script>
    <script type="text/javascript" src="/theme/js/index.min.js"></script>
    <!--<script>twemoji.parse(document, {"size":16});</script>-->
</body>
</html>